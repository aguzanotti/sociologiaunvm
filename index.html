<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tablero de Graduados en Sociología - UNVM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chrono-node/1.3.11/chrono.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.0/Recharts.min.js"></script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    .section-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .section-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    .fade-in {
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <div id="root" class="container mx-auto p-6 max-w-7xl"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [selectedYear, setSelectedYear] = useState(null);
      const [tableData, setTableData] = useState([]);

      useEffect(() => {
        Papa.parse(loadFileData("egresados_cruzados.csv"), {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          transformHeader: (header) => header.trim().replace(/^"|"$/g, ''),
          transform: (value, header) => {
            let cleaned = value.trim().replace(/^"|"$/g, '');
            if (header === 'promedio') {
              return parseFloat(cleaned.replace(',', '.'));
            }
            if (header === 'fecha_ingreso' || header === 'fecha_egreso') {
              const parsedDate = chrono.parseDate(cleaned);
              return parsedDate ? parsedDate : null;
            }
            return cleaned;
          },
          complete: (results) => {
            const cleanedData = results.data.map(row => ({
              ...row,
              gender: row['Certificado'].includes('LICENCIADA') ? 'Femenino' : 'Masculino',
              duration: row['fecha_egreso'] && row['fecha_ingreso'] ? 
                (row['fecha_egreso'].getFullYear() - row['fecha_ingreso'].getFullYear()) + 
                (row['fecha_egreso'].getMonth() - row['fecha_ingreso'].getMonth()) / 12 : null
            }));
            // Inicializar la tabla con todos los graduados, ordenados por fecha de egreso
            const sortedData = [...cleanedData].sort((a, b) => new Date(a['fecha_egreso']) - new Date(b['fecha_egreso']));
            setData(cleanedData);
            setTableData(sortedData);
            setLoading(false);
          },
          error: (err) => {
            console.error('Error al parsear CSV:', err);
            setLoading(false);
          }
        });
      }, []);

      const handleYearClick = (event) => {
        if (event && event.activePayload && event.activePayload[0]) {
          const year = event.activePayload[0].payload.year;
          setSelectedYear(year);
          const filteredData = data.filter(row => row['fecha_egreso'] && row['fecha_egreso'].getFullYear() === year);
          filteredData.sort((a, b) => new Date(a['fecha_egreso']) - new Date(b['fecha_egreso']));
          setTableData(filteredData);
        } else {
          // Si se hace clic fuera de un punto de datos, mostrar todos los graduados
          const sortedData = [...data].sort((a, b) => new Date(a['fecha_egreso']) - new Date(b['fecha_egreso']));
          setSelectedYear(null);
          setTableData(sortedData);
        }
      };

      if (loading) {
        return (
          <div className="text-center text-2xl text-gray-600 p-10">
            <i className="fas fa-spinner fa-spin mr-2"></i> Cargando datos...
          </div>
        );
      }

      const totalGraduados = data.length;
      const promedioGeneral = (data.reduce((sum, row) => sum + (row['promedio'] || 0), 0) / totalGraduados).toFixed(2);
      const conteoGenero = data.reduce((acc, row) => {
        acc[row.gender] = (acc[row.gender] || 0) + 1;
        return acc;
      }, {});
      const duracionPromedio = (data.reduce((sum, row) => sum + (row.duration || 0), 0) / data.filter(row => row.duration).length).toFixed(2);

      const binsPromedio = Array(10).fill(0).map((_, i) => ({
        rango: `${(5 + i * 0.5).toFixed(1)}-${(5.5 + i * 0.5).toFixed(1)}`,
        cantidad: data.filter(row => row['promedio'] >= 5 + i * 0.5 && row['promedio'] < 5.5 + i * 0.5).length
      }));

      const binsDuracion = Array(10).fill(0).map((_, i) => ({
        rango: `${(i * 2)}-${((i + 1) * 2)}`,
        cantidad: data.filter(row => row.duration >= i * 2 && row.duration < (i + 1) * 2).length
      }));

      const anosGraduacion = data.reduce((acc, row) => {
        if (row['fecha_egreso']) {
          const year = row['fecha_egreso'].getFullYear();
          acc[year] = (acc[year] || 0) + 1;
        }
        return acc;
      }, {});
      const datosAnos = Object.entries(anosGraduacion).map(([year, count]) => ({ year: parseInt(year), count }));

      return (
        <div className="bg-white shadow-lg rounded-lg p-8 fade-in">
          <h1 className="text-4xl font-bold text-center text-indigo-700 mb-8">
            <i className="fas fa-graduation-cap mr-2"></i> Tablero de Graduados en Sociología - UNVM
          </h1>

          <section className="mb-12 section-card bg-gray-50 p-6 rounded-lg">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4"><i className="fas fa-info-circle mr-2"></i> Resumen</h2>
            <p className="text-gray-600 mb-4">
              Este tablero presenta un análisis de {totalGraduados} graduados en Sociología de la Universidad Nacional de Villa María (UNVM). 
              Se incluyen métricas clave como el promedio histórico, distribución por género, tiempo de finalización y cantidad de graduados.
            </p>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div className="bg-indigo-100 p-4 rounded-lg text-center">
                <p className="text-sm text-indigo-600">Total de Graduados</p>
                <p className="text-2xl font-bold text-indigo-800">{totalGraduados}</p>
              </div>
              <div className="bg-indigo-100 p-4 rounded-lg text-center">
                <p className="text-sm text-indigo-600">Promedio General</p>
                <p className="text-2xl font-bold text-indigo-800">{promedioGeneral}</p>
              </div>
              <div className="bg-indigo-100 p-4 rounded-lg text-center">
                <p className="text-sm text-indigo-600">Tiempo Promedio</p>
                <p className="text-2xl font-bold text-indigo-800">{duracionPromedio} años</p>
              </div>
              <div className="bg-indigo-100 p-4 rounded-lg text-center">
                <p className="text-sm text-indigo-600">Distribución por Género</p>
                <p className="text-2xl font-bold text-indigo-800">{conteoGenero.Masculino || 0} M / {conteoGenero.Femenino || 0} F</p>
              </div>
            </div>
          </section>

          <section className="mb-12 section-card bg-white p-6 rounded-lg">
            <h2 className="text-xl font-semibold text-gray-800 mb-4"><i className="fas fa-chart-bar mr-2"></i> Distribución de Promedios</h2>
            <Recharts.ResponsiveContainer width="100%" height={300}>
              <Recharts.BarChart data={binsPromedio}>
                <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <Recharts.XAxis dataKey="rango" fontSize={12} stroke="#4b5563" />
                <Recharts.YAxis fontSize={12} stroke="#4b5563" />
                <Recharts.Tooltip contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e5e7eb' }} />
                <Recharts.Legend />
                <Recharts.Bar dataKey="cantidad" fill="#4f46e5" radius={[4, 4, 0, 0]} />
              </Recharts.BarChart>
            </Recharts.ResponsiveContainer>
          </section>

          <section className="mb-12 section-card bg-white p-6 rounded-lg">
            <h2 className="text-xl font-semibold text-gray-800 mb-4"><i className="fas fa-users mr-2"></i> Distribución por Género</h2>
            <Recharts.ResponsiveContainer width="100%" height={300}>
              <Recharts.PieChart>
                <Recharts.Pie
                  data={Object.entries(conteoGenero).map(([gender, count]) => ({ name: gender, value: count }))}
                  dataKey="value"
                  nameKey="name"
                  cx="50%"
                  cy="50%"
                  outerRadius={100}
                  fill="#8884d8"
                  label
                >
                  {Object.entries(conteoGenero).map((entry, index) => (
                    <Recharts.Cell key={`cell-${index}`} fill={index % 2 === 0 ? '#4f46e5' : '#7dd3fc'} />
                  ))}
                </Recharts.Pie>
                <Recharts.Tooltip contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e5e7eb' }} />
                <Recharts.Legend />
              </Recharts.PieChart>
            </Recharts.ResponsiveContainer>
          </section>

          <section className="mb-12 section-card bg-white p-6 rounded-lg">
            <h2 className="text-xl font-semibold text-gray-800 mb-4"><i className="fas fa-clock mr-2"></i> Distribución de Tiempo de Egreso</h2>
            <Recharts.ResponsiveContainer width="100%" height={300}>
              <Recharts.BarChart data={binsDuracion}>
                <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <Recharts.XAxis dataKey="rango" fontSize={12} stroke="#4b5563" label={{ value: 'Años', position: 'insideBottom', offset: -5 }} />
                <Recharts.YAxis fontSize={12} stroke="#4b5563" label={{ value: 'Cantidad', angle: -90, position: 'insideLeft' }} />
                <Recharts.Tooltip contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e5e7eb' }} />
                <Recharts.Legend />
                <Recharts.Bar dataKey="cantidad" fill="#10b981" radius={[4, 4, 0, 0]} />
              </Recharts.BarChart>
            </Recharts.ResponsiveContainer>
          </section>

          <section className="mb-12 section-card bg-white p-6 rounded-lg">
            <h2 className="text-xl font-semibold text-gray-800 mb-4"><i className="fas fa-calendar-alt mr-2"></i> Graduados por Año</h2>
            <Recharts.ResponsiveContainer width="100%" height={300}>
              <Recharts.LineChart data={datosAnos} onClick={handleYearClick}>
                <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <Recharts.XAxis dataKey="year" fontSize={12} stroke="#4b5563" />
                <Recharts.YAxis fontSize={12} stroke="#4b5563" />
                <Recharts.Tooltip contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e5e7eb' }} />
                <Recharts.Legend />
                <Recharts.Line type="monotone" dataKey="count" stroke="#4f46e5" strokeWidth={2} />
              </Recharts.LineChart>
            </Recharts.ResponsiveContainer>
          </section>

          <section className="mb-12 section-card bg-white p-6 rounded-lg">
            <h2 className="text-xl font-semibold text-gray-800 mb-4"><i className="fas fa-table mr-2"></i> Graduados {selectedYear ? `en ${selectedYear}` : 'Totales'}</h2>
            <div className="overflow-x-auto">
              <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead>
                  <tr className="bg-indigo-50 text-indigo-800">
                    <th className="px-6 py-3 border text-left">Apellido y Nombre</th>
                    <th className="px-6 py-3 border text-left">Fecha de Egreso</th>
                  </tr>
                </thead>
                <tbody>
                  {tableData.length > 0 ? (
                    tableData.map((row, index) => (
                      <tr key={index} className="hover:bg-indigo-50 transition-colors">
                        <td className="px-6 py-3 border">{row['Apellido y Nombre']}</td>
                        <td className="px-6 py-3 border">{row['fecha_egreso'].toLocaleDateString('es-ES')}</td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan="2" className="px-6 py-3 border text-center">No hay graduados disponibles</td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </section>

          <section className="section-card bg-white p-6 rounded-lg">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4"><i className="fas fa-file-alt mr-2"></i> Conclusión</h2>
            <p className="text-gray-600">
              Los datos reflejan un sólido desempeño académico de los graduados en Sociología de la UNVM, con un promedio general de <span className="font-semibold">{promedioGeneral}</span>. 
              La distribución por género muestra una representación equilibrada, con una ligera mayoría femenina. El tiempo promedio de finalización es de aproximadamente <span className="font-semibold">{duracionPromedio} años</span>. 
              La cantidad de graduados ha variado a lo largo de los años, con picos en ciertos períodos. Este análisis ofrece información valiosa sobre la trayectoria académica de los graduados en Sociología de la UNVM.
            </p>
          </section>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
